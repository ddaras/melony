---
description: Standards and patterns for building Melony AI agents using the fluent builder API.
globs: **/agents/*.ts, **/plugins/*.ts, **/api/chat/*.ts
alwaysApply: false
---

# Melony Core Patterns

Melony is an event-based framework for AI agents. Use the `melony()` builder to define agents.

## Basic Agent Structure

```typescript
import { melony } from "melony";

export const agent = melony<State, Events>()
  .use(plugin)             // Load plugins (e.g., aiSDKPlugin, persistencePlugin)
  .on("event", handler)    // Handle events
  .build();                // Finalize the agent
```

## AI Integration (Vercel AI SDK)

Use `@melony/plugin-ai-sdk` to integrate LLMs and tools.

```typescript
import { aiSDKPlugin } from "@melony/plugin-ai-sdk";
import { openai } from "@ai-sdk/openai";

builder.use(aiSDKPlugin({
  model: openai("gpt-4o"),
  system: "You are a helpful assistant.",
  toolDefinitions: {
    getWeather: {
      description: "Get weather",
      inputSchema: z.object({ city: z.string() }),
    }
  }
}));

// Tool calls trigger events named "action:TOOL_NAME"
builder.on("action:getWeather", weatherHandler);
```

## Next.js API Routes (Streaming & Init)

Melony supports both streaming (chat) and JSON (initialization) responses.

```typescript
// app/api/chat/route.ts
import { agent } from "../../agents/my-agent";

// POST for streaming agent responses
export async function POST(req: Request) {
  const { event } = await req.json();
  return agent.streamResponse(event); 
}

// GET for initial UI state (non-streaming)
export async function GET(req: Request) {
  return agent.jsonResponse({ type: "init", data: {} });
}
```

## Core Concepts

- **Events**: Objects with `{ type, data }`.
- **Handlers**: Functions `async function* (event, context)`. Registered with `.on("type", handler)`.
- **Reactivity**: Yielding an event from a handler triggers other handlers recursively.
- **Plugins**: Use `.use()` to add capabilities (observability, persistence, AI).

## Best Practices
- **Plugins**: Modularize logic using `MelonyPlugin`.
- **Naming**: Use `action:name` for tool handlers.
- **Initialization**: Use `jsonResponse` for the first load to get the full UI state without streaming.
